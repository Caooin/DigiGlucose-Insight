# 糖小智 - 血糖健康管理助手

基于 FastAPI + LangChain + React 的智能血糖管理助手系统，采用多 Agent 协同架构，提供对话驱动的健康管理服务。

## ✨ 功能特性

### 核心功能
- 🤖 **多智能体架构**：数据记录、即时分析、教育科普、情感支持四大专业 Agent
- 💬 **智能对话**：
  - 基于云雾 API 的自然语言理解，支持自然对话记录数据
  - **对话历史管理**：自动保存所有对话记录，支持查看和继续历史对话
  - **口语化识别**：智能识别用户口语化描述的血糖测量场景（如"没吃饭的时候测的"、"吃完饭后测的"等）
- 📊 **数据管理**：血糖、饮食、运动、药物记录
- 📈 **周报分析**：自动生成周报，包含统计、模式识别、行动建议
- 👤 **用户认证**：
  - 完整的登录注册系统，JWT Token 认证
  - **邮箱验证注册**：注册时需验证邮箱，确保一个邮箱一个账号
  - 密码强度要求（至少8位，包含大小写字母和数字）
- 🔒 **数据隔离**：每个用户只能查看和管理自己的数据

### 邮箱验证注册功能
- 📧 **邮箱验证码**：
  - 注册时发送6位数字验证码到用户邮箱
  - 验证码有效期10分钟，一次性使用
  - 支持163 VIP邮箱、QQ邮箱等多种邮件服务商
  - 防刷机制：1分钟内只能获取1次，24小时内最多5次
- 🔐 **安全机制**：
  - 邮箱唯一性双重保障（数据库唯一索引 + 业务层校验）
  - 验证码使用后立即失效
  - 密码bcrypt加密存储

### 数据可视化
- 📊 **数据可视化图表**：
  - 折线图：展示血糖数值变化趋势
  - 柱状图：展示空腹/餐后血糖对比
  - 饼图：展示饮食GI值分布（高GI/低GI占比）
  - 支持时间区间筛选（近7天、14天、30天、90天）
  - 支持测量类型筛选（空腹、餐后、全部等）
  - 图表悬停显示详细数据
  - 完美适配暗色主题

### 趋势分析
- 📉 **趋势分析图表**：
  - 带趋势线的折线图，自动标注趋势（上升/下降/平稳）
  - 异常值高亮标注（超出目标范围的血糖值）
  - 统计分析：平均值、标准差、最高值、最低值
  - 自动生成文字解读（如"近7天餐后血糖呈下降趋势，平均降幅0.3"）
  - 支持切换分析周期（短期7天/中期30天/长期90天）
  - 支持筛选血糖类型（空腹/餐后）
  - 完美适配暗色主题

### 提醒功能
- ⏰ **智能提醒管理**：
  - 支持四种提醒类型：血糖测量、服药、饮食控制、复诊
  - 灵活的重复设置：每日、每周（可选择具体日期）、每月、仅一次
  - Web Notification API 本地提醒（需用户授权）
  - 提醒管理：创建、编辑、删除、开启/关闭
  - 完成状态标记：可标记提醒为已完成
  - 提醒完成率统计

### 数据导出
- 💾 **多格式数据导出**：
  - **CSV格式**：UTF-8-BOM编码，Excel完美兼容，支持中文显示
  - **Excel格式**：带样式和格式，美观易读，适合打印
  - **PDF格式**：报告形式，支持中文字体，适合分享给医生或存档
  - 支持时间区间选择（近7天到近1年）
  - 自动生成规范的文件名（如：DigiGlucose_血糖数据_20240101-20240630.csv）
  - 单次导出数据量限制，避免超时

### 移动端优化
- 📱 **响应式设计**：
  - 适配手机、平板、桌面等不同屏幕尺寸
  - 移动端汉堡菜单（侧边栏自动隐藏）
  - 优化的触摸操作（按钮最小44px×44px）
  - 表单输入适配移动端键盘
  - 优化的滑动和下拉刷新操作
  - 压缩静态资源，减少HTTP请求

### 主题系统
- 🌙 **暗色主题支持**：
  - 亮色/暗色主题切换
  - 跟随系统主题自动切换
  - 主题偏好保存到localStorage
  - 所有组件完美适配两种主题
  - 高对比度文字颜色，确保可读性
  - 图表元素自动适配主题

### 智能 Agent 功能
1. **数据记录 Agent**：
   - 结构化抽取用户输入的数据（血糖值、单位、时间、上下文等）
   - **口语化场景识别**：自动识别用户口语化描述的血糖测量场景
     - 空腹：没吃饭的时候测的、饿了一晚上之后测的、没吃早饭那会测的、肚子空着的时候测的
     - 餐后：吃完饭后测的、刚吃完饭那阵儿测的、吃饱东西之后测的、用餐结束后测的
     - 餐前：吃饭前测的、准备开饭的时候测的、没吃饭之前测的、要吃饭了先测的
     - 随机：随便啥时候测的、想起来就测的时候、没固定时间测的、任意时候测的
2. **即时分析 Agent**：实时分析血糖值，提供风险评估和建议
3. **教育科普 Agent**：提供糖尿病相关知识科普
4. **情感支持 Agent**：提供情感支持和鼓励

### 对话历史功能
- 📝 **对话记录管理**：
  - 自动保存所有对话到历史记录
  - 每个历史对话以北京时间命名（精确到秒），格式：`YYYY-MM-DD HH:mm:ss`
  - 支持查看对话列表，显示对话时间和最后一条消息预览
  - 点击历史对话可继续该对话
  - 当前活跃对话高亮显示
- 🔄 **智能对话切换**：
  - 从其他页面切换回对话助手时，自动保存当前对话并创建新对话
  - 支持手动创建新对话
  - 对话数据持久化存储，切换页面或刷新不丢失
- 🎨 **用户体验**：
  - 侧边栏历史对话列表，支持展开/折叠
  - 移动端优化的历史对话界面
  - 支持暗色主题

## 🚀 快速开始

### 环境要求
- Python 3.8+
- Node.js 16+
- SQLite（自动创建）

### 1. 后端设置

#### 步骤 1：创建虚拟环境（推荐）

```powershell
# 进入后端目录
cd "backend"

# 创建虚拟环境（使用 .venv 作为文件夹名）
python -m venv .venv

# 激活虚拟环境（Windows PowerShell）
.\.venv\Scripts\Activate.ps1

# 如果 PowerShell 执行策略限制，先运行：
# Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

**激活成功的标志**：命令行提示符前会显示 `(.venv)`

#### 步骤 2：安装依赖

```powershell
# 确保虚拟环境已激活（看到 (.venv) 前缀）
# 升级 pip（可选，但推荐）
python -m pip install --upgrade pip

# 安装项目依赖
# 注意：requirements.txt 在 backend 目录下
pip install -r requirements.txt

# 或者使用绝对路径（如果在项目根目录）
pip install -r "C:\Users\lenovo\Desktop\Health Management\backend\requirements.txt"
```

#### 步骤 3：配置环境变量

##### 3.1 配置云雾 API（必需）

```powershell
# 设置环境变量（云雾 API 配置）
$env:YUNWU_API_KEY="sk-YyCYXQPvPUKViIaX8wrbtjVatojJh9L25Ov82Mh36QuS0e6V"
$env:YUNWU_BASE_URL="https://api.yunwu.ai/v1"
```

或者创建 `.env` 文件（推荐）：
```env
YUNWU_API_KEY=sk-YyCYXQPvPUKViIaX8wrbtjVatojJh9L25Ov82Mh36QuS0e6V
YUNWU_BASE_URL=https://api.yunwu.ai/v1
```

##### 3.2 配置邮件服务（可选，用于邮箱验证码）

在项目根目录创建 `.env` 文件（如果还没有），添加邮件服务配置：

```env
# SMTP邮件服务器配置
SMTP_HOST=smtp.vip.163.com          # 163 VIP邮箱SMTP服务器
SMTP_PORT=25                         # SMTP端口（163 VIP邮箱使用25）
SMTP_USER=your_email@vip.163.com    # 发件人邮箱
SMTP_PASSWORD=your_auth_code         # 邮箱授权码（不是登录密码）
SMTP_FROM_NAME=糖小智血糖健康助手    # 发件人名称
```

**常见邮箱服务商配置**：

- **163 VIP邮箱**：
  ```env
  SMTP_HOST=smtp.vip.163.com
  SMTP_PORT=25
  ```

- **QQ邮箱**：
  ```env
  SMTP_HOST=smtp.qq.com
  SMTP_PORT=587
  ```

- **163普通邮箱**：
  ```env
  SMTP_HOST=smtp.163.com
  SMTP_PORT=25
  ```

**注意**：
- 如果不配置SMTP，系统会在控制台输出验证码，方便开发测试
- 生产环境建议配置真实的SMTP服务
- 详细配置说明请参考 [backend/EMAIL_SETUP.md](./backend/EMAIL_SETUP.md)

#### 步骤 4：数据库迁移（首次运行或更新后）

如果数据库已存在，需要运行迁移脚本添加新字段：

```powershell
# 确保虚拟环境已激活
python migrate_database.py
```

#### 步骤 5：启动后端服务器

```powershell
# 确保虚拟环境已激活
python -m uvicorn app.main:app --reload
```

后端将在 `http://127.0.0.1:8000` 启动。

#### 退出虚拟环境

```powershell
# 完成后退出虚拟环境
deactivate
```

#### ⚠️ 注意事项

- **每次使用前**：都需要先激活虚拟环境（`.\.venv\Scripts\Activate.ps1`）
- **如果已存在虚拟环境**：直接激活即可，无需重新创建
- **虚拟环境位置**：`backend/.venv/` 文件夹（已在 .gitignore 中忽略）

### 2. 前端设置（新开一个 PowerShell 窗口）

```powershell
# 进入前端目录
cd "frontend"

# 安装依赖（首次运行）
npm install

# 启动开发服务器
npm run dev
```

前端依赖包括：
- `react`、`react-dom`：React框架
- `echarts`、`echarts-for-react`：数据可视化图表库
- `xlsx`：Excel文件处理
- `jspdf`、`jspdf-autotable`：PDF生成

前端将在 `http://localhost:5173` 启动。

### 3. 访问应用

1. 打开浏览器访问：`http://localhost:5173`
2. 首次访问会显示登录页面（强制登录）
3. **注册新账号**：
   - 填写用户名、邮箱、密码
   - 点击"获取验证码"按钮
   - 查看邮箱（或后端控制台）获取验证码
   - 输入验证码完成注册
4. 或登录已有账号
5. 登录后完善个人信息
6. 开始使用各项功能

### 4. 主题切换

- 点击侧边栏底部的🌙/☀️图标可切换亮色/暗色主题
- 主题偏好会自动保存，下次访问时会自动应用
- 支持跟随系统主题（如果未手动设置主题）

### 5. 移动端使用

- 在手机浏览器中访问应用
- 自动适配移动端布局（侧边栏变为汉堡菜单）
- 优化的触摸操作体验
- 所有功能在移动端均可正常使用

## 📁 项目结构

```
Health Management/
├── backend/                    # FastAPI 后端
│   ├── app/
│   │   ├── main.py            # FastAPI 应用入口
│   │   ├── api.py             # API 路由定义
│   │   ├── models.py          # 数据库模型
│   │   ├── database.py        # 数据库配置
│   │   ├── auth.py            # 认证模块（JWT）
│   │   ├── auth_schemas.py    # 认证数据模式
│   │   ├── email_service.py   # 邮件发送服务
│   │   ├── orchestrator.py    # 多 Agent 协调器
│   │   ├── agents.py          # 专业 Agent 实现
│   │   ├── tools.py           # LangChain Tools
│   │   ├── mcp.py             # MCP 核心协调器
│   │   ├── weekly_report.py   # 周报生成
│   │   └── schemas.py         # Pydantic 模式
│   ├── requirements.txt       # Python 依赖
│   ├── migrate_database.py    # 数据库迁移脚本
│   ├── EMAIL_SETUP.md         # 邮件服务配置说明
│   └── README_BACKEND.md      # 后端文档
├── frontend/                  # React 前端
│   ├── src/
│   │   ├── App.jsx            # 主应用组件
│   │   ├── Login.jsx          # 登录/注册组件
│   │   ├── Chat.jsx           # 对话组件
│   │   ├── Profile.jsx        # 个人档案组件
│   │   ├── GlucoseRecords.jsx      # 血糖记录组件
│   │   ├── WeeklyReport.jsx        # 周报组件
│   │   ├── GlucoseVisualization.jsx # 数据可视化组件
│   │   ├── TrendAnalysis.jsx       # 趋势分析组件
│   │   ├── Reminders.jsx           # 提醒管理组件
│   │   ├── DataExport.jsx          # 数据导出组件
│   │   ├── auth.js                 # 认证工具函数
│   │   └── *.css                   # 样式文件
│   ├── package.json           # Node.js 依赖
│   ├── vite.config.js         # Vite 配置
│   └── 前端功能说明.md         # 前端功能说明
├── health_management.db       # SQLite 数据库（自动创建）
├── .env                       # 环境变量配置（需自行创建）
├── README.md                  # 项目主文档
├── 登录注册功能使用说明.md     # 登录注册详细说明
├── 前端完成清单.md             # 前端功能清单
└── 虚拟环境使用指南.md         # 虚拟环境使用指南
```

## 🔧 技术栈

### 后端
- **FastAPI**：现代 Python Web 框架
- **SQLAlchemy**：ORM 数据库操作
- **SQLite**：轻量级数据库
- **JWT**：用户认证（python-jose）
- **bcrypt**：密码加密
- **LangChain**：LLM 集成
- **Pydantic**：数据验证
- **openpyxl**：Excel文件生成
- **reportlab**：PDF报告生成
- **smtplib**：邮件发送（Python标准库）
- **python-dotenv**：环境变量管理

### 前端
- **React 18**：UI 框架
- **Vite**：构建工具
- **原生 Fetch API**：HTTP 请求
- **ECharts**：数据可视化图表库（echarts-for-react）
- **xlsx**：Excel文件处理
- **jsPDF**：PDF文件生成（jspdf-autotable）
- **CSS变量**：主题系统支持

## 📋 API 端点

### 认证相关
- `POST /api/auth/register` - 用户注册（需验证码）
- `POST /api/auth/login` - 用户登录
- `POST /api/auth/send-verify-code` - 获取邮箱验证码
- `GET /api/auth/me` - 获取当前用户信息

### 数据相关（需要认证）
- `POST /api/chat` - 智能对话
- `GET /api/users/profile` - 获取用户档案
- `PUT /api/users/profile` - 更新用户档案
- `GET /api/users/glucose-readings` - 获取血糖记录
- `GET /api/users/weekly-report` - 获取周报

### 数据可视化（需要认证）
- `GET /api/users/glucose-visualization` - 获取血糖可视化数据（折线图）
- `GET /api/users/glucose-comparison` - 获取空腹/餐后血糖对比数据（柱状图）
- `GET /api/users/diet-visualization` - 获取饮食可视化数据（饼图）
- `GET /api/users/glucose-trend` - 获取血糖趋势分析数据（带趋势线和异常标注）

### 提醒功能（需要认证）
- `GET /api/users/reminders` - 获取所有提醒
- `POST /api/users/reminders` - 创建提醒
- `PUT /api/users/reminders/{id}` - 更新提醒
- `DELETE /api/users/reminders/{id}` - 删除提醒

### 数据导出（需要认证）
- `GET /api/users/export/csv` - 导出CSV格式数据
- `GET /api/users/export/excel` - 导出Excel格式数据
- `GET /api/users/export/pdf` - 导出PDF格式报告

## 💡 使用示例

### 注册账号

1. 访问注册页面
2. 填写用户名、邮箱、密码（至少8位，包含大小写字母和数字）
3. 点击"获取验证码"按钮
4. 查看邮箱收件箱（或后端控制台）获取验证码
5. 输入6位验证码
6. 点击"注册"完成注册

### 对话记录数据

#### 基本对话示例
```
用户：我刚测了血糖，7.8
助手：已记录您的血糖值 7.8 mmol/L。这个数值在正常范围内，很好！

用户：早餐后2小时测的
助手：已更新记录，标记为餐后2小时测量。

用户：这个数值高吗？
助手：您的餐后血糖值 7.8 mmol/L 在正常范围内...
```

#### 口语化场景识别示例
系统能够智能识别用户口语化描述的血糖测量场景，自动归类到对应的标准类型：

```
用户：我刚测了血糖，7.5，没吃饭的时候测的
助手：已记录您的血糖值 7.5 mmol/L（空腹）。这个数值在正常范围内，很好！

用户：血糖8.2，吃完饭后测的
助手：已记录您的血糖值 8.2 mmol/L（餐后）。这个数值略高于目标范围...

用户：7.0，准备开饭的时候测的
助手：已记录您的血糖值 7.0 mmol/L（餐前）。这个数值在正常范围内，很好！

用户：6.8，随便啥时候测的
助手：已记录您的血糖值 6.8 mmol/L（随机）。这个数值在正常范围内...
```

**支持的口语表述类型**：
- **空腹场景**：没吃饭的时候测的、饿了一晚上之后测的、没吃早饭那会测的、肚子空着的时候测的
- **餐后场景**：吃完饭后测的、刚吃完饭那阵儿测的、吃饱东西之后测的、用餐结束后测的
- **餐前场景**：吃饭前测的、准备开饭的时候测的、没吃饭之前测的、要吃饭了先测的
- **随机场景**：随便啥时候测的、想起来就测的时候、没固定时间测的、任意时候测的

### 查看数据
- **对话助手**：
  - 通过自然语言记录和查询数据
  - 支持口语化描述血糖测量场景
  - 查看和管理对话历史
  - 切换回对话助手时自动创建新对话
- **个人档案**：查看和编辑个人信息、目标区间
- **血糖记录**：查看历史血糖记录，包含风险等级和测量类型（空腹/餐后/餐前/随机）
- **数据可视化**：查看血糖变化趋势图表、对比图表、饮食分布图表
- **趋势分析**：查看血糖趋势分析，包括趋势线、异常值标注、统计解读
- **周报分析**：查看本周统计分析、模式识别、行动建议

### 使用对话历史功能
- 查看历史对话：点击对话助手页面左上角的"☰"按钮打开历史对话列表
- 继续历史对话：在历史对话列表中点击任意对话即可继续
- 创建新对话：点击"+ 新建对话"按钮或从其他页面切换回来时自动创建
- 对话自动保存：所有对话自动保存，无需手动操作

### 使用提醒功能
- 进入"提醒管理"页面
- 点击"+ 新建提醒"按钮
- 选择提醒类型、设置时间、重复频率
- 保存后系统会在指定时间发送提醒通知
- 可编辑、删除、开启/关闭提醒
- 可标记提醒为已完成

### 导出数据
- 进入"数据导出"页面
- 选择时间范围（近7天到近1年）
- 选择导出格式（CSV、Excel、PDF）
- 点击对应格式卡片即可下载文件

## 🔒 安全特性

- ✅ 密码 bcrypt 加密存储
- ✅ JWT Token 认证（30天有效期）
- ✅ API 端点保护（需要认证）
- ✅ 数据隔离（用户只能访问自己的数据）
- ✅ Token 过期自动处理
- ✅ **邮箱验证注册**：确保一个邮箱一个账号
- ✅ **验证码安全**：10分钟有效期，一次性使用
- ✅ **防刷机制**：1分钟内1次，24小时内最多5次
- ✅ **密码强度要求**：至少8位，包含大小写字母和数字

## 📝 数据库模型

- **User**：用户信息（用户名、邮箱、密码哈希、邮箱验证状态、个人信息、目标区间）
- **EmailVerifyCode**：邮箱验证码（邮箱、验证码、过期时间、使用状态、IP地址）
- **GlucoseReading**：血糖记录（值、单位、时间、上下文、风险等级）
- **MealEntry**：餐饮记录
- **ExerciseRecord**：运动记录
- **MedicationRecord**：药物记录
- **ConversationState**：对话状态
- **AnalysisEvent**：分析事件
- **WeeklyReport**：周报记录
- **Reminder**：提醒记录（类型、标题、内容、时间、重复设置、状态）

## ⚠️ 注意事项

1. **首次使用**：需要先注册账号（需邮箱验证），然后完善个人信息
2. **登录要求**：无论是否有token，每次访问都需要先登录（不自动登录）
3. **API Key**：使用云雾 API，已配置默认 API Key，如需更换请设置环境变量
4. **数据库**：首次运行会自动创建 SQLite 数据库
5. **数据库迁移**：如果更新了数据库模型，需要运行 `migrate_database.py` 进行迁移
6. **Token 存储**：Token 存储在 localStorage 中，生产环境建议使用更安全的方式
7. **密码重置**：当前版本不支持密码重置功能
8. **提醒通知**：浏览器需要授权通知权限才能收到提醒
9. **数据导出**：单次导出数据量较大时可能需要较长时间，请耐心等待
10. **邮件服务**：如果不配置SMTP，验证码会在后端控制台输出（开发模式）

## 🐛 故障排除

### 登录后跳转到登录页
- 检查浏览器控制台是否有错误
- 确认 token 是否正确保存到 localStorage
- 检查后端日志，确认 token 验证是否成功
- **注意**：当前版本要求每次访问都必须先登录，不会自动登录

### API 返回 401 错误
- 确认已登录且 token 未过期
- 检查请求头中是否包含 `Authorization: Bearer <token>`
- 查看后端日志，确认 token 验证过程

### 数据库连接错误
- 确认数据库文件权限
- 检查数据库文件路径是否正确
- 尝试删除数据库文件，让系统重新创建
- 如果更新了模型，运行 `migrate_database.py` 进行迁移

### 图表不显示
- 确认已安装前端依赖（`npm install`）
- 检查浏览器控制台是否有JavaScript错误
- 确认ECharts库已正确加载

### 提醒功能不工作
- 确认浏览器已授权通知权限（检查浏览器地址栏的锁图标）
- 确认提醒已启用且时间设置正确
- 检查系统时间是否正确

### 数据导出失败
- 确认后端依赖已安装（openpyxl、reportlab）
- 检查浏览器控制台是否有错误
- 确认导出数据量不要过大（建议单次导出不超过1000条记录）

### 验证码发送失败
- 检查 `.env` 文件中的SMTP配置是否正确
- 确认邮箱授权码是否有效（不是登录密码）
- 查看后端控制台日志，确认错误信息
- 如果不配置SMTP，验证码会在控制台输出（开发模式）

### 邮件被退回
- 检查From字段格式是否正确（已使用formataddr自动处理）
- 确认SMTP配置是否正确
- 查看邮件服务商的退信信息

## 🔍 技术亮点

### 口语化场景识别
系统采用正则表达式模式匹配和关键词识别技术，能够智能识别用户口语化描述的血糖测量场景：
- **模式匹配**：使用正则表达式匹配常见口语表述模式
- **优先级机制**：空腹 > 餐前 > 餐后 > 随机，确保准确识别
- **降级策略**：口语识别 → 标准关键词 → 时间推断，多层级保障
- **实时处理**：在数据记录过程中实时识别，无需额外步骤

### 对话历史管理
- **本地存储**：使用localStorage实现对话历史持久化
- **自动命名**：使用北京时间（精确到秒）作为对话名称
- **智能切换**：组件重新挂载时自动保存并创建新对话
- **状态管理**：使用React Hooks管理对话状态和会话ID

### 邮箱验证注册
- **双重保障**：数据库唯一索引 + 业务层校验，确保邮箱唯一性
- **防刷机制**：基于邮箱和IP的限流，防止恶意刷取验证码
- **安全存储**：验证码加密存储，使用后立即失效
- **多服务商支持**：支持163 VIP、QQ、Gmail等多种邮件服务商

## 📚 相关文档

- [虚拟环境使用指南](./虚拟环境使用指南.md) - 如何创建和使用 Python 虚拟环境
- [登录注册功能使用说明](./登录注册功能使用说明.md) - 详细的登录注册功能说明
- [前端完成清单](./前端完成清单.md) - 前端功能完成情况
- [backend/EMAIL_SETUP.md](./backend/EMAIL_SETUP.md) - 邮件服务配置详细说明

## 📄 许可证

本项目仅供学习和研究使用。

